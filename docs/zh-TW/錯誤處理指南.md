# éŒ¯èª¤è™•ç†æŒ‡å—

å…¨é¢çš„éŒ¯èª¤è™•ç†æŒ‡å—ï¼Œå¹«åŠ©æ‚¨åœ¨ä½¿ç”¨ SpringMVC Agent Analyzer æ™‚å„ªé›…åœ°è™•ç†å„ç¨®éŒ¯èª¤æƒ…æ³ã€‚

## ğŸ“‹ ç›®éŒ„

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [éŒ¯èª¤æ ¼å¼ç³»çµ±](#éŒ¯èª¤æ ¼å¼ç³»çµ±)
3. [å¸¸è¦‹éŒ¯èª¤é¡å‹](#å¸¸è¦‹éŒ¯èª¤é¡å‹)
4. [ä½¿ç”¨ç¯„ä¾‹](#ä½¿ç”¨ç¯„ä¾‹)
5. [é€²éšåŠŸèƒ½](#é€²éšåŠŸèƒ½)
6. [æœ€ä½³å¯¦è¸](#æœ€ä½³å¯¦è¸)
7. [è‡ªè¨‚éŒ¯èª¤è™•ç†](#è‡ªè¨‚éŒ¯èª¤è™•ç†)
8. [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)

---

## æ¦‚è¿°

SpringMVC Agent Analyzer ä½¿ç”¨**æ¨™æº–åŒ–éŒ¯èª¤æ ¼å¼ç³»çµ±** (`ErrorFormatter`) æä¾›ä¸€è‡´ã€è©³ç´°çš„éŒ¯èª¤è¨Šæ¯ï¼Œå¹«åŠ©æ‚¨å¿«é€Ÿå®šä½å’Œè§£æ±ºå•é¡Œã€‚

### ç‚ºä»€éº¼éœ€è¦æ¨™æº–åŒ–éŒ¯èª¤æ ¼å¼ï¼Ÿ

**âŒ å‚³çµ±éŒ¯èª¤è¨Šæ¯ï¼š**
```python
# ä¸ä¸€è‡´ã€é›£ä»¥ç†è§£
raise Exception("Error in file")
raise ValueError(f"Invalid: {value}")
print(f"Failed: {error}")  # ä¸åŒæ ¼å¼
```

**âœ… æ¨™æº–åŒ–éŒ¯èª¤è¨Šæ¯ï¼š**
```python
# ä¸€è‡´ã€è©³ç´°ã€å¯æ“ä½œ
error_msg = ErrorFormatter.format_error_message(
    error_type="FileNotFoundError",
    component="file_processor",
    details="ç„¡æ³•è®€å–æª”æ¡ˆ",
    context={"file_path": path, "reason": "æª”æ¡ˆä¸å­˜åœ¨"},
    suggestions=["æª¢æŸ¥æª”æ¡ˆè·¯å¾‘", "ç¢ºèªæª”æ¡ˆæ¬Šé™"]
)
```

### éŒ¯èª¤è¨Šæ¯çµæ§‹

æ‰€æœ‰éŒ¯èª¤éµå¾ªä¸€è‡´çš„çµæ§‹ï¼š

```
[éŒ¯èª¤é¡å‹] å…ƒä»¶åç¨±: è©³ç´°èªªæ˜

Context:
  - éµ1: å€¼1
  - éµ2: å€¼2

Suggestions:
  - å»ºè­° 1
  - å»ºè­° 2
```

---

## éŒ¯èª¤æ ¼å¼ç³»çµ±

### å¿«é€Ÿé–‹å§‹ï¼ˆ30 ç§’ï¼‰

```python
from sdk_agent.error_formatter import ErrorFormatter

# åŸºæœ¬éŒ¯èª¤è¨Šæ¯
error_msg = ErrorFormatter.format_error_message(
    error_type="ValueError",
    component="my_module",
    details="è¼¸å…¥å€¼ç„¡æ•ˆ",
    context={"input": user_input, "expected": "æ­£æ•´æ•¸"},
    suggestions=["æª¢æŸ¥è¼¸å…¥æ ¼å¼", "åªä½¿ç”¨æ­£æ•´æ•¸"]
)
print(error_msg)
```

**è¼¸å‡ºï¼š**
```
[ValueError] my_module: è¼¸å…¥å€¼ç„¡æ•ˆ

Context:
  - input: -5
  - expected: æ­£æ•´æ•¸

Suggestions:
  - æª¢æŸ¥è¼¸å…¥æ ¼å¼
  - åªä½¿ç”¨æ­£æ•´æ•¸
```

### æ ¸å¿ƒ API

`ErrorFormatter` é¡åˆ¥æä¾›ä»¥ä¸‹æ–¹æ³•ï¼š

| æ–¹æ³• | ç”¨é€” | é©ç”¨å ´æ™¯ |
|------|------|----------|
| `format_error_message()` | é€šç”¨éŒ¯èª¤æ ¼å¼åŒ– | ä»»ä½•éŒ¯èª¤æƒ…æ³ |
| `format_file_error()` | æª”æ¡ˆæ“ä½œéŒ¯èª¤ | è®€å¯«æª”æ¡ˆå¤±æ•— |
| `format_validation_error()` | é©—è­‰éŒ¯èª¤ | è¼¸å…¥é©—è­‰å¤±æ•— |
| `format_configuration_error()` | è¨­å®šéŒ¯èª¤ | è¨­å®šåƒæ•¸ç„¡æ•ˆ |
| `format_processing_error()` | è™•ç†éŒ¯èª¤ | æ‰¹æ¬¡è™•ç†å¤±æ•— |

---

## å¸¸è¦‹éŒ¯èª¤é¡å‹

### 1. æª”æ¡ˆæ“ä½œéŒ¯èª¤

ç•¶æª”æ¡ˆè®€å¯«æ“ä½œå¤±æ•—æ™‚ä½¿ç”¨ã€‚

**ç¯„ä¾‹ï¼š**

```python
from sdk_agent.error_formatter import ErrorFormatter

try:
    with open(file_path, 'r', encoding='utf-8') as f:
        content = f.read()
except FileNotFoundError as e:
    error_msg = ErrorFormatter.format_file_error(
        file_path="UserController.java",
        error=e,
        operation="read",
        suggestions=[
            "æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨",
            "ç¢ºèªæª”æ¡ˆè·¯å¾‘æ­£ç¢º",
            "é©—è­‰æª”æ¡ˆæ¬Šé™å¯è®€"
        ]
    )
    raise FileNotFoundError(error_msg) from e
```

**è¼¸å‡ºï¼š**
```
[FileNotFoundError] file_operation: ç„¡æ³•è®€å–æª”æ¡ˆ

Context:
  - file_path: UserController.java
  - error_message: [Errno 2] No such file or directory: 'UserController.java'

Suggestions:
  - æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨
  - ç¢ºèªæª”æ¡ˆè·¯å¾‘æ­£ç¢º
  - é©—è­‰æª”æ¡ˆæ¬Šé™å¯è®€
```

**å¸¸è¦‹æª”æ¡ˆéŒ¯èª¤ï¼š**

| éŒ¯èª¤é¡å‹ | åŸå›  | è§£æ±ºæ–¹æ¡ˆ |
|----------|------|----------|
| `FileNotFoundError` | æª”æ¡ˆä¸å­˜åœ¨ | æª¢æŸ¥è·¯å¾‘ï¼Œä½¿ç”¨çµ•å°è·¯å¾‘ |
| `PermissionError` | æ¬Šé™ä¸è¶³ | ä¿®æ”¹æª”æ¡ˆæ¬Šé™ï¼ˆchmodï¼‰ |
| `IsADirectoryError` | è·¯å¾‘æ˜¯ç›®éŒ„ | ç¢ºèªè·¯å¾‘æŒ‡å‘æª”æ¡ˆ |
| `UnicodeDecodeError` | ç·¨ç¢¼éŒ¯èª¤ | æŒ‡å®šæ­£ç¢ºç·¨ç¢¼ï¼ˆutf-8ï¼‰ |

### 2. é©—è­‰éŒ¯èª¤

ç•¶è¼¸å…¥åƒæ•¸é©—è­‰å¤±æ•—æ™‚ä½¿ç”¨ã€‚

**ç¯„ä¾‹ï¼š**

```python
from sdk_agent.error_formatter import ErrorFormatter

def validate_batch_size(batch_size: int):
    """é©—è­‰æ‰¹æ¬¡å¤§å°"""
    if batch_size < 1:
        error_msg = ErrorFormatter.format_validation_error(
            field_name="batch_size",
            value=batch_size,
            expected="å¿…é ˆ >= 1",
            suggestions=[
                "ä½¿ç”¨è‡³å°‘ç‚º 1 çš„æ‰¹æ¬¡å¤§å°",
                "å»ºè­°ï¼š10-50 ä»¥ç²å¾—æœ€ä½³æ•ˆèƒ½"
            ]
        )
        raise ValueError(error_msg)

# ä½¿ç”¨
try:
    validate_batch_size(0)
except ValueError as e:
    print(e)
```

**è¼¸å‡ºï¼š**
```
[ValidationError] validation: 'batch_size' çš„å€¼ç„¡æ•ˆ

Context:
  - field: batch_size
  - provided: 0
  - expected: å¿…é ˆ >= 1

Suggestions:
  - ä½¿ç”¨è‡³å°‘ç‚º 1 çš„æ‰¹æ¬¡å¤§å°
  - å»ºè­°ï¼š10-50 ä»¥ç²å¾—æœ€ä½³æ•ˆèƒ½
```

### 3. è¨­å®šéŒ¯èª¤

ç•¶è¨­å®šåƒæ•¸ç„¡æ•ˆæ™‚ä½¿ç”¨ã€‚

**ç¯„ä¾‹ï¼š**

```python
from sdk_agent.error_formatter import ErrorFormatter

def validate_config(max_concurrency: int):
    """é©—è­‰ä¸¦è¡Œæ•¸è¨­å®š"""
    if not (1 <= max_concurrency <= 100):
        error_msg = ErrorFormatter.format_configuration_error(
            parameter="max_concurrency",
            value=max_concurrency,
            valid_range="1-100",
            suggestions=[
                "è¨­å®š max_concurrency åœ¨ 1 åˆ° 100 ä¹‹é–“",
                "å»ºè­°ï¼š5-10 ä»¥ç²å¾—æœ€ä½³æ•ˆèƒ½"
            ]
        )
        raise ValueError(error_msg)

# ä½¿ç”¨
try:
    validate_config(200)
except ValueError as e:
    print(e)
```

**è¼¸å‡ºï¼š**
```
[ConfigurationError] configuration: è¨­å®šåƒæ•¸ 'max_concurrency' ç„¡æ•ˆ

Context:
  - parameter: max_concurrency
  - provided_value: 200
  - valid_range: 1-100

Suggestions:
  - è¨­å®š max_concurrency åœ¨ 1 åˆ° 100 ä¹‹é–“
  - å»ºè­°ï¼š5-10 ä»¥ç²å¾—æœ€ä½³æ•ˆèƒ½
```

### 4. æ‰¹æ¬¡è™•ç†éŒ¯èª¤

ç•¶æ‰¹æ¬¡è™•ç†å¤±æ•—æ™‚ä½¿ç”¨ã€‚

**ç¯„ä¾‹ï¼š**

```python
from pathlib import Path
from sdk_agent.error_formatter import ErrorFormatter

async def process_file(file_path: Path, batch_num: int, total_batches: int):
    """è™•ç†å–®ä¸€æª”æ¡ˆ"""
    try:
        # è™•ç†æª”æ¡ˆ...
        result = await analyzer.analyze_file(str(file_path))
        return {"success": True, "result": result}

    except Exception as e:
        error_msg = ErrorFormatter.format_processing_error(
            item=str(file_path),
            error=e,
            batch_info={
                "batch": batch_num,
                "total_batches": total_batches,
                "files_in_batch": 20
            }
        )
        return {"success": False, "error": error_msg}
```

**è¼¸å‡ºï¼š**
```
[ProcessingError] batch_processor: è™•ç†é …ç›®å¤±æ•—

Context:
  - item: /path/to/UserController.java
  - error_type: ValueError
  - error_message: Invalid Java syntax on line 45
  - batch: 3
  - total_batches: 10
  - files_in_batch: 20

Suggestions:
  - æª¢æŸ¥é …ç›®æ˜¯å¦å­˜åœ¨ä¸”å¯å­˜å–
  - ç¢ºèªé …ç›®æ ¼å¼æ­£ç¢º
  - æŸ¥çœ‹æ—¥èªŒä»¥ç²å–è©³ç´°éŒ¯èª¤è³‡è¨Š
```

---

## ä½¿ç”¨ç¯„ä¾‹

### ç¯„ä¾‹ 1: å®Œæ•´çš„æª”æ¡ˆåˆ†æéŒ¯èª¤è™•ç†

```python
from pathlib import Path
from sdk_agent.client import SpringMVCAnalyzerAgent
from sdk_agent.error_formatter import ErrorFormatter
from sdk_agent.exceptions import SDKAgentError

async def safe_analyze_file(file_path: str):
    """å®‰å…¨çš„æª”æ¡ˆåˆ†æï¼ˆå«å®Œæ•´éŒ¯èª¤è™•ç†ï¼‰"""

    # æ­¥é©Ÿ 1: é©—è­‰æª”æ¡ˆå­˜åœ¨
    path = Path(file_path)
    if not path.exists():
        error_msg = ErrorFormatter.format_file_error(
            file_path=file_path,
            error=FileNotFoundError(f"æª”æ¡ˆä¸å­˜åœ¨: {file_path}"),
            operation="analyze",
            suggestions=[
                f"ç¢ºèªæª”æ¡ˆå­˜åœ¨æ–¼: {path.absolute()}",
                "ä½¿ç”¨çµ•å°è·¯å¾‘è€Œéç›¸å°è·¯å¾‘",
                "æª¢æŸ¥æª”æ¡ˆåç¨±æ‹¼å¯«"
            ]
        )
        return {"success": False, "error": error_msg}

    # æ­¥é©Ÿ 2: é©—è­‰æª”æ¡ˆå¯è®€
    if not path.is_file():
        error_msg = ErrorFormatter.format_file_error(
            file_path=file_path,
            error=IsADirectoryError(f"è·¯å¾‘æ˜¯ç›®éŒ„: {file_path}"),
            operation="analyze",
            suggestions=[
                "ç¢ºèªè·¯å¾‘æŒ‡å‘æª”æ¡ˆè€Œéç›®éŒ„",
                f"ä½¿ç”¨: {path}/YourFile.java"
            ]
        )
        return {"success": False, "error": error_msg}

    # æ­¥é©Ÿ 3: åŸ·è¡Œåˆ†æ
    try:
        agent = SpringMVCAnalyzerAgent()
        result = await agent.analyze_file(file_path)

        return {"success": True, "result": result}

    except SDKAgentError as e:
        error_msg = ErrorFormatter.format_processing_error(
            item=file_path,
            error=e,
            batch_info={"stage": "analysis"}
        )
        return {"success": False, "error": error_msg}

    except Exception as e:
        error_msg = ErrorFormatter.format_error_message(
            error_type=type(e).__name__,
            component="file_analyzer",
            details=f"åˆ†ææª”æ¡ˆæ™‚ç™¼ç”Ÿæœªé æœŸçš„éŒ¯èª¤",
            context={
                "file_path": file_path,
                "error_message": str(e)
            },
            suggestions=[
                "æŸ¥çœ‹è©³ç´°æ—¥èªŒ",
                "ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢º",
                "å˜—è©¦åˆ†æè¼ƒå°çš„æª”æ¡ˆ",
                "å›å ±æ­¤å•é¡Œåˆ° GitHub Issues"
            ]
        )
        return {"success": False, "error": error_msg}

# ä½¿ç”¨ç¯„ä¾‹
result = await safe_analyze_file("src/main/java/UserController.java")

if result['success']:
    print("âœ… åˆ†ææˆåŠŸ")
    print(result['result'])
else:
    print("âŒ åˆ†æå¤±æ•—")
    print(result['error'])
```

### ç¯„ä¾‹ 2: æ‰¹æ¬¡è™•ç†å«éŒ¯èª¤æ¢å¾©

```python
from sdk_agent.error_formatter import ErrorFormatter
import logging

logger = logging.getLogger(__name__)

async def robust_batch_analysis(file_paths: list[str]):
    """å¼·å¥çš„æ‰¹æ¬¡åˆ†æï¼ˆå«éŒ¯èª¤æ¢å¾©ï¼‰"""

    results = []
    errors = []

    for i, file_path in enumerate(file_paths, 1):
        print(f"è™•ç† [{i}/{len(file_paths)}]: {file_path}")

        try:
            result = await safe_analyze_file(file_path)

            if result['success']:
                results.append(result['result'])
                print("  âœ… æˆåŠŸ")
            else:
                errors.append({
                    "file": file_path,
                    "error": result['error']
                })
                print(f"  âŒ å¤±æ•—")
                logger.error(result['error'])

        except Exception as e:
            # å³ä½¿å–®ä¸€æª”æ¡ˆå¤±æ•—ï¼Œç¹¼çºŒè™•ç†å…¶ä»–æª”æ¡ˆ
            error_msg = ErrorFormatter.format_processing_error(
                item=file_path,
                error=e,
                batch_info={
                    "current": i,
                    "total": len(file_paths)
                }
            )
            errors.append({
                "file": file_path,
                "error": error_msg
            })
            logger.error(error_msg)
            print(f"  âš ï¸  ä¾‹å¤–ç‹€æ³ï¼Œç¹¼çºŒè™•ç†...")

    # ç”¢ç”Ÿæ‘˜è¦å ±å‘Š
    print("\n" + "="*60)
    print(f"æ‰¹æ¬¡è™•ç†å®Œæˆ:")
    print(f"  æˆåŠŸ: {len(results)}/{len(file_paths)}")
    print(f"  å¤±æ•—: {len(errors)}/{len(file_paths)}")

    if errors:
        print(f"\nå¤±æ•—çš„æª”æ¡ˆ:")
        for err in errors:
            print(f"  - {err['file']}")

    return {
        "results": results,
        "errors": errors,
        "success_rate": len(results) / len(file_paths) * 100
    }

# ä½¿ç”¨ç¯„ä¾‹
files = [
    "Controller1.java",
    "Controller2.java",
    "Controller3.java"
]

report = await robust_batch_analysis(files)

if report['success_rate'] == 100:
    print("\nğŸ‰ æ‰€æœ‰æª”æ¡ˆåˆ†ææˆåŠŸï¼")
elif report['success_rate'] >= 80:
    print(f"\nâœ… å¤§éƒ¨åˆ†æˆåŠŸ ({report['success_rate']:.1f}%)")
else:
    print(f"\nâš ï¸  æˆåŠŸç‡è¼ƒä½ ({report['success_rate']:.1f}%)ï¼Œè«‹æª¢æŸ¥éŒ¯èª¤")
```

### ç¯„ä¾‹ 3: çµæ§‹åŒ–æ—¥èªŒè¨˜éŒ„

```python
from sdk_agent.error_formatter import log_structured_error
import logging

# è¨­å®šæ—¥èªŒ
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('analyzer.log', encoding='utf-8'),
        logging.StreamHandler()
    ]
)

logger = logging.getLogger(__name__)

async def logged_analysis(file_path: str):
    """å¸¶çµæ§‹åŒ–æ—¥èªŒçš„åˆ†æ"""

    try:
        agent = SpringMVCAnalyzerAgent()
        result = await agent.analyze_file(file_path)

        logger.info(f"æˆåŠŸåˆ†æ: {file_path}")
        return result

    except FileNotFoundError as e:
        # ä½¿ç”¨çµæ§‹åŒ–éŒ¯èª¤æ—¥èªŒ
        log_structured_error(
            logger_obj=logger,
            error=e,
            component="file_analyzer",
            context={
                "operation": "analyze_file",
                "file_path": file_path,
                "file_exists": Path(file_path).exists()
            },
            level=logging.ERROR
        )
        raise

    except Exception as e:
        log_structured_error(
            logger_obj=logger,
            error=e,
            component="file_analyzer",
            context={
                "operation": "analyze_file",
                "file_path": file_path
            },
            level=logging.CRITICAL
        )
        raise
```

---

## é€²éšåŠŸèƒ½

### 1. ä¸Šä¸‹æ–‡æˆªæ–·

å¤§å‹ä¸Šä¸‹æ–‡å€¼æœƒè‡ªå‹•æˆªæ–·ï¼Œé˜²æ­¢æ—¥èªŒéé•·ï¼š

```python
from sdk_agent.error_formatter import ErrorFormatter

# å¤§å‹è³‡æ–™æœƒè‡ªå‹•è™•ç†
large_data = "x" * 10000  # 10,000 å€‹å­—å…ƒ

error_msg = ErrorFormatter.format_error_message(
    error_type="DataError",
    component="data_processor",
    details="è™•ç†å¤§å‹è³‡æ–™é›†å¤±æ•—",
    context={
        "data": large_data,  # æœƒæˆªæ–·åˆ° 500 å­—å…ƒ
        "rows": 1000000
    }
)

print(error_msg)
```

**è¼¸å‡ºï¼š**
```
[DataError] data_processor: è™•ç†å¤§å‹è³‡æ–™é›†å¤±æ•—

Context:
  - data: xxxxx... [truncated]
  - rows: 1000000
```

**æˆªæ–·è¦å‰‡ï¼š**
- å–®ä¸€å€¼æœ€å¤§é•·åº¦ï¼š**500 å­—å…ƒ**
- ç¸½ä¸Šä¸‹æ–‡æœ€å¤§é•·åº¦ï¼š**2000 å­—å…ƒ**

### 2. å¯é…ç½®çš„æˆªæ–·é™åˆ¶

æ ¹æ“šéœ€æ±‚èª¿æ•´æˆªæ–·é™åˆ¶ï¼š

```python
from sdk_agent.error_formatter import ErrorFormatter

# é è¨­é™åˆ¶ï¼ˆ500/2000ï¼‰
error_msg = ErrorFormatter.format_error_message(
    error_type="Error",
    component="component",
    details="è©³ç´°èªªæ˜",
    context=large_context
)

# è‡ªè¨‚é™åˆ¶
error_msg = ErrorFormatter.format_error_message(
    error_type="Error",
    component="component",
    details="è©³ç´°èªªæ˜",
    context=large_context,
    max_context_value_length=1000,  # æ¯å€‹å€¼ 1000 å­—å…ƒ
    max_total_context_length=5000   # ç¸½å…± 5000 å­—å…ƒ
)

# è©³ç´°æ¨¡å¼ï¼ˆç„¡æˆªæ–·ï¼‰
error_msg = ErrorFormatter.format_error_message(
    error_type="Error",
    component="component",
    details="è©³ç´°èªªæ˜",
    context=large_context,
    max_context_value_length=-1,    # -1 = åœç”¨æˆªæ–·
    max_total_context_length=-1
)
```

### 3. æˆªæ–·æ—¥èªŒè¿½è¹¤

è¿½è¹¤æˆªæ–·äº‹ä»¶ä»¥é€²è¡Œç›£æ§ï¼š

```python
import logging
from sdk_agent.error_formatter import ErrorFormatter

# è¨­å®š DEBUG å±¤ç´šä»¥æŸ¥çœ‹æˆªæ–·æ—¥èªŒ
logging.basicConfig(level=logging.DEBUG)

logger = logging.getLogger('sdk_agent.error_formatter')

# ç•¶ç™¼ç”Ÿæˆªæ–·æ™‚ï¼Œæœƒè¨˜éŒ„ DEBUG è¨Šæ¯
error_msg = ErrorFormatter.format_error_message(
    error_type="Error",
    component="component",
    details="è©³ç´°èªªæ˜",
    context={"large_data": "x" * 1000}
)

# DEBUG è¼¸å‡º:
# Truncated context value: 'large_data' (original: 1000 chars, limit: 500)
```

### 4. å‹åˆ¥åˆ¥å

ä½¿ç”¨å‹åˆ¥åˆ¥åæé«˜ç¨‹å¼ç¢¼å¯è®€æ€§ï¼š

```python
from sdk_agent.error_formatter import ErrorContext, SuggestionList

def my_error_handler(
    context: ErrorContext,      # Dict[str, Any]
    suggestions: SuggestionList  # List[str]
) -> str:
    """è‡ªè¨‚éŒ¯èª¤è™•ç†å™¨"""
    return ErrorFormatter.format_error_message(
        error_type="CustomError",
        component="my_component",
        details="ç™¼ç”ŸéŒ¯èª¤",
        context=context,
        suggestions=suggestions
    )

# ä½¿ç”¨
error_msg = my_error_handler(
    context={"file": "test.java", "line": 42},
    suggestions=["æª¢æŸ¥èªæ³•", "ç¢ºèªå¼•å…¥"]
)
```

---

## æœ€ä½³å¯¦è¸

### 1. ç¸½æ˜¯æä¾›ä¸Šä¸‹æ–‡

ä¸Šä¸‹æ–‡è³‡è¨Šå°è¨ºæ–·å•é¡Œè‡³é—œé‡è¦ã€‚

**âŒ ä¸å¥½çš„åšæ³•ï¼š**
```python
# ç¼ºä¹ä¸Šä¸‹æ–‡
error_msg = ErrorFormatter.format_error_message(
    error_type="ProcessingError",
    component="processor",
    details="è™•ç†å¤±æ•—"
)
```

**âœ… å¥½çš„åšæ³•ï¼š**
```python
# æä¾›è±å¯Œçš„ä¸Šä¸‹æ–‡
error_msg = ErrorFormatter.format_error_message(
    error_type="ProcessingError",
    component="processor",
    details="è™•ç†æª”æ¡ˆå¤±æ•—",
    context={
        "file_path": file_path,
        "file_size": file_size,
        "encoding": encoding,
        "line_number": line_num,
        "operation": "parse_annotations"
    }
)
```

### 2. æä¾›å¯æ“ä½œçš„å»ºè­°

å»ºè­°æ‡‰è©²å…·é«”ä¸”å¯åŸ·è¡Œã€‚

**âŒ æ¨¡ç³Šçš„å»ºè­°ï¼š**
```python
suggestions=["ä¿®å¾©éŒ¯èª¤", "å†è©¦ä¸€æ¬¡"]
```

**âœ… å…·é«”çš„å»ºè­°ï¼š**
```python
suggestions=[
    "ç¢ºèªæª”æ¡ˆå­˜åœ¨æ–¼: /path/to/file",
    "æª¢æŸ¥æª”æ¡ˆæ¬Šé™ï¼ˆæ‡‰è©²å¯è®€ï¼‰: chmod +r file.java",
    "é©—è­‰æª”æ¡ˆç·¨ç¢¼ç‚º UTF-8: file -i file.java"
]
```

### 3. ä½¿ç”¨é©ç•¶çš„éŒ¯èª¤é¡å‹

é¸æ“‡æœ€å…·é«”çš„éŒ¯èª¤é¡å‹ã€‚

**âŒ ä¸å¤ å…·é«”ï¼š**
```python
error_type="Error"  # å¤ªé€šç”¨
```

**âœ… å…·é«”æ˜ç¢ºï¼š**
```python
error_type="FileNotFoundError"      # æª”æ¡ˆä¸å­˜åœ¨
error_type="ValidationError"        # é©—è­‰å¤±æ•—
error_type="ConfigurationError"     # è¨­å®šéŒ¯èª¤
error_type="ProcessingError"        # è™•ç†éŒ¯èª¤
```

### 4. ä½¿ç”¨å°ˆé–€çš„æ ¼å¼åŒ–æ–¹æ³•

ç›¡å¯èƒ½ä½¿ç”¨å°ˆé–€çš„æ ¼å¼åŒ–æ–¹æ³•ã€‚

**âŒ ä½¿ç”¨é€šç”¨æ–¹æ³•ï¼š**
```python
error_msg = ErrorFormatter.format_error_message(
    error_type="FileNotFoundError",
    component="file_operation",
    details="æ‰¾ä¸åˆ°æª”æ¡ˆ",
    context={"file": path}
)
```

**âœ… ä½¿ç”¨å°ˆé–€æ–¹æ³•ï¼š**
```python
error_msg = ErrorFormatter.format_file_error(
    file_path=path,
    error=FileNotFoundError("æ‰¾ä¸åˆ°æª”æ¡ˆ"),
    operation="read"
)
```

### 5. çµæ§‹åŒ–æ—¥èªŒè¨˜éŒ„

å§‹çµ‚ä½¿ç”¨çµæ§‹åŒ–æ—¥èªŒä»¥ä¿æŒä¸€è‡´æ€§ã€‚

**âŒ åŸºæœ¬æ—¥èªŒï¼š**
```python
logger.error(f"{component} ç™¼ç”ŸéŒ¯èª¤: {str(error)}")
```

**âœ… çµæ§‹åŒ–æ—¥èªŒï¼š**
```python
log_structured_error(
    logger_obj=logger,
    error=error,
    component=component,
    context={"additional": "info"}
)
```

### 6. éŒ¯èª¤æ¢å¾©ç­–ç•¥

å¯¦ä½œæ¼¸é€²å¼éŒ¯èª¤æ¢å¾©ï¼š

```python
async def resilient_analyze(file_path: str, max_retries: int = 3):
    """å…·æœ‰é‡è©¦æ©Ÿåˆ¶çš„åˆ†æ"""

    for attempt in range(1, max_retries + 1):
        try:
            result = await agent.analyze_file(file_path)
            return {"success": True, "result": result}

        except Exception as e:
            if attempt == max_retries:
                # æœ€å¾Œä¸€æ¬¡å˜—è©¦ï¼Œè¨˜éŒ„ä¸¦å›å ±éŒ¯èª¤
                error_msg = ErrorFormatter.format_processing_error(
                    item=file_path,
                    error=e,
                    batch_info={
                        "attempts": attempt,
                        "max_retries": max_retries
                    }
                )
                logger.error(error_msg)
                return {"success": False, "error": error_msg}

            # é‡è©¦å‰ç­‰å¾…
            wait_time = 2 ** attempt  # æŒ‡æ•¸é€€é¿
            logger.warning(
                f"å˜—è©¦ {attempt}/{max_retries} å¤±æ•—ï¼Œ{wait_time}ç§’å¾Œé‡è©¦..."
            )
            await asyncio.sleep(wait_time)

# ä½¿ç”¨
result = await resilient_analyze("UserController.java", max_retries=3)
```

---

## è‡ªè¨‚éŒ¯èª¤è™•ç†

### å»ºç«‹è‡ªè¨‚ç•°å¸¸é¡åˆ¥

```python
from sdk_agent.exceptions import SDKAgentError
from sdk_agent.error_formatter import ErrorFormatter

class AnalysisTimeoutError(SDKAgentError):
    """åˆ†æé€¾æ™‚éŒ¯èª¤"""

    def __init__(self, file_path: str, timeout: int):
        error_msg = ErrorFormatter.format_error_message(
            error_type="AnalysisTimeoutError",
            component="analyzer",
            details=f"åˆ†æé€¾æ™‚ï¼ˆè¶…é {timeout} ç§’ï¼‰",
            context={
                "file_path": file_path,
                "timeout_seconds": timeout
            },
            suggestions=[
                f"å¢åŠ é€¾æ™‚æ™‚é–“ï¼ˆç›®å‰: {timeout}ç§’ï¼‰",
                "æª¢æŸ¥æª”æ¡ˆå¤§å°æ˜¯å¦éå¤§",
                "ç¢ºèªç¶²è·¯é€£ç·šç©©å®š"
            ]
        )
        super().__init__(error_msg)
        self.file_path = file_path
        self.timeout = timeout

# ä½¿ç”¨
try:
    result = await analyze_with_timeout("LargeController.java", timeout=30)
except AnalysisTimeoutError as e:
    print(f"éŒ¯èª¤: {e}")
    print(f"æª”æ¡ˆ: {e.file_path}, é€¾æ™‚: {e.timeout}ç§’")
```

### éŒ¯èª¤è™•ç†è£é£¾å™¨

```python
from functools import wraps
from sdk_agent.error_formatter import ErrorFormatter
import logging

logger = logging.getLogger(__name__)

def handle_errors(component: str):
    """éŒ¯èª¤è™•ç†è£é£¾å™¨"""

    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            try:
                return await func(*args, **kwargs)

            except Exception as e:
                error_msg = ErrorFormatter.format_error_message(
                    error_type=type(e).__name__,
                    component=component,
                    details=f"åŸ·è¡Œ {func.__name__} æ™‚ç™¼ç”ŸéŒ¯èª¤",
                    context={
                        "function": func.__name__,
                        "args": str(args),
                        "kwargs": str(kwargs),
                        "error": str(e)
                    },
                    suggestions=[
                        "æŸ¥çœ‹è©³ç´°æ—¥èªŒ",
                        "ç¢ºèªè¼¸å…¥åƒæ•¸æ­£ç¢º",
                        "æª¢æŸ¥ç³»çµ±è³‡æº"
                    ]
                )
                logger.error(error_msg)
                raise type(e)(error_msg) from e

        return wrapper
    return decorator

# ä½¿ç”¨
@handle_errors(component="file_analyzer")
async def analyze_file(file_path: str):
    """åˆ†ææª”æ¡ˆ"""
    # ... å¯¦ä½œ ...
    pass
```

---

## æ•…éšœæ’é™¤

### å•é¡Œ 1: ä¸Šä¸‹æ–‡æœªé¡¯ç¤º

**ç—‡ç‹€ï¼š** éŒ¯èª¤è¨Šæ¯ä¸­æ²’æœ‰ Context å€å¡Š

**åŸå› ï¼š** context åƒæ•¸ä¸æ˜¯å­—å…¸

**è§£æ±ºæ–¹æ¡ˆï¼š**

```python
# âŒ éŒ¯èª¤
context = "some string"

# âœ… æ­£ç¢º
context = {"key": "value"}
```

### å•é¡Œ 2: å»ºè­°æœªé¡¯ç¤º

**ç—‡ç‹€ï¼š** éŒ¯èª¤è¨Šæ¯ä¸­æ²’æœ‰ Suggestions å€å¡Š

**åŸå› ï¼š** suggestions åƒæ•¸ä¸æ˜¯åˆ—è¡¨

**è§£æ±ºæ–¹æ¡ˆï¼š**

```python
# âŒ éŒ¯èª¤
suggestions = "Try this"

# âœ… æ­£ç¢º
suggestions = ["Try this", "And this"]
```

### å•é¡Œ 3: ä¸Šä¸‹æ–‡è¢«æˆªæ–·

**ç—‡ç‹€ï¼š** ä¸Šä¸‹æ–‡å€¼é¡¯ç¤º `... [truncated]`

**åŸå› ï¼š** ä¸Šä¸‹æ–‡å€¼è¶…éé™åˆ¶ï¼ˆ500 å­—å…ƒï¼‰

**è§£æ±ºæ–¹æ¡ˆï¼š**

```python
# æ–¹æ¡ˆ 1: æ¸›å°‘è³‡æ–™é‡
context = {
    "file_size": len(file_content),
    "first_100_chars": file_content[:100],
    "encoding": "utf-8"
}

# æ–¹æ¡ˆ 2: å¢åŠ é™åˆ¶
error_msg = ErrorFormatter.format_error_message(
    ...,
    context=large_context,
    max_context_value_length=2000,  # å¢åŠ åˆ° 2000
    max_total_context_length=10000  # å¢åŠ åˆ° 10000
)

# æ–¹æ¡ˆ 3: åœç”¨æˆªæ–·ï¼ˆåƒ…ç”¨æ–¼é™¤éŒ¯ï¼‰
error_msg = ErrorFormatter.format_error_message(
    ...,
    context=large_context,
    max_context_value_length=-1,
    max_total_context_length=-1
)
```

### å•é¡Œ 4: æ—¥èªŒä¸­å‡ºç¾å¤§é‡éŒ¯èª¤

**ç—‡ç‹€ï¼š** æ—¥èªŒæª”æ¡ˆå¿«é€Ÿå¢é•·ï¼Œå……æ»¿éŒ¯èª¤è¨Šæ¯

**åŸå› ï¼š** éŒ¯èª¤è™•ç†ä¸ç•¶ï¼Œé‡è¤‡è¨˜éŒ„ç›¸åŒéŒ¯èª¤

**è§£æ±ºæ–¹æ¡ˆï¼š**

```python
# âŒ ä¸å¥½ï¼šé‡è¤‡è¨˜éŒ„
try:
    result = await process()
except Exception as e:
    logger.error(str(e))  # è¨˜éŒ„ 1
    log_structured_error(logger, e, "comp")  # è¨˜éŒ„ 2 (é‡è¤‡ï¼)
    raise

# âœ… å¥½ï¼šåªè¨˜éŒ„ä¸€æ¬¡
try:
    result = await process()
except Exception as e:
    log_structured_error(logger, e, "component", context)
    raise  # ä¸è¦å†è¨˜éŒ„

# âœ… æ›´å¥½ï¼šåœ¨æœ€å¤–å±¤çµ±ä¸€è™•ç†
try:
    result = await complex_operation()
    return result
except Exception as e:
    # åªåœ¨æœ€å¤–å±¤è¨˜éŒ„éŒ¯èª¤
    log_structured_error(logger, e, "main", context)
    return {"success": False, "error": str(e)}
```

---

## æ¸¬è©¦éŒ¯èª¤è¨Šæ¯

ç¢ºä¿éŒ¯èª¤è¨Šæ¯æ ¼å¼æ­£ç¢ºï¼š

```python
import pytest
from sdk_agent.error_formatter import ErrorFormatter

def test_error_message_format():
    """æ¸¬è©¦éŒ¯èª¤è¨Šæ¯æ ¼å¼æ­£ç¢º"""
    error_msg = ErrorFormatter.format_validation_error(
        field_name="batch_size",
        value=0,
        expected="å¿…é ˆ >= 1"
    )

    # æª¢æŸ¥æ ¼å¼
    assert "[ValidationError]" in error_msg
    assert "batch_size" in error_msg
    assert "Context:" in error_msg
    assert "provided: 0" in error_msg
    assert "expected: å¿…é ˆ >= 1" in error_msg

def test_file_error_format():
    """æ¸¬è©¦æª”æ¡ˆéŒ¯èª¤æ ¼å¼"""
    error_msg = ErrorFormatter.format_file_error(
        file_path="test.java",
        error=FileNotFoundError("File not found"),
        operation="read"
    )

    assert "[FileNotFoundError]" in error_msg
    assert "file_operation" in error_msg
    assert "test.java" in error_msg
    assert "Suggestions:" in error_msg

def test_context_truncation():
    """æ¸¬è©¦ä¸Šä¸‹æ–‡æˆªæ–·"""
    large_value = "x" * 1000

    error_msg = ErrorFormatter.format_error_message(
        error_type="Error",
        component="test",
        details="Test",
        context={"large": large_value}
    )

    assert "truncated" in error_msg
    assert len(error_msg) < len(large_value)
```

---

## API åƒè€ƒ

### ErrorFormatter é¡åˆ¥

#### `format_error_message()`

é€šç”¨éŒ¯èª¤æ ¼å¼åŒ–å™¨ã€‚

**åƒæ•¸ï¼š**
- `error_type: str` - éŒ¯èª¤é¡å‹åç¨±
- `component: str` - ç™¼ç”ŸéŒ¯èª¤çš„å…ƒä»¶
- `details: str` - éŒ¯èª¤è©³ç´°èªªæ˜
- `context: Optional[ErrorContext]` - ä¸Šä¸‹æ–‡è³‡è¨Šï¼ˆé è¨­: Noneï¼‰
- `suggestions: Optional[SuggestionList]` - ä¿®å¾©å»ºè­°ï¼ˆé è¨­: Noneï¼‰
- `max_context_value_length: int` - å–®ä¸€å€¼æœ€å¤§é•·åº¦ï¼ˆé è¨­: 500ï¼Œ-1 = åœç”¨ï¼‰
- `max_total_context_length: int` - ç¸½é•·åº¦é™åˆ¶ï¼ˆé è¨­: 2000ï¼Œ-1 = åœç”¨ï¼‰

**å›å‚³ï¼š** `str` - æ ¼å¼åŒ–çš„éŒ¯èª¤è¨Šæ¯

#### `format_file_error()`

æ ¼å¼åŒ–æª”æ¡ˆæ“ä½œéŒ¯èª¤ã€‚

**åƒæ•¸ï¼š**
- `file_path: str` - æª”æ¡ˆè·¯å¾‘
- `error: Exception` - ç™¼ç”Ÿçš„ç•°å¸¸
- `operation: str` - æ“ä½œé¡å‹ï¼ˆå¦‚ "read"ã€"write"ï¼‰
- `suggestions: Optional[SuggestionList]` - è‡ªè¨‚å»ºè­°ï¼ˆé è¨­: Noneï¼‰

**å›å‚³ï¼š** `str` - æ ¼å¼åŒ–çš„éŒ¯èª¤è¨Šæ¯

#### `format_validation_error()`

æ ¼å¼åŒ–é©—è­‰éŒ¯èª¤ã€‚

**åƒæ•¸ï¼š**
- `field_name: str` - é©—è­‰å¤±æ•—çš„æ¬„ä½åç¨±
- `value: Any` - æä¾›çš„ç„¡æ•ˆå€¼
- `expected: str` - é æœŸå€¼çš„èªªæ˜
- `suggestions: Optional[SuggestionList]` - ä¿®å¾©å»ºè­°ï¼ˆé è¨­: Noneï¼‰

**å›å‚³ï¼š** `str` - æ ¼å¼åŒ–çš„éŒ¯èª¤è¨Šæ¯

#### `format_configuration_error()`

æ ¼å¼åŒ–è¨­å®šåƒæ•¸éŒ¯èª¤ã€‚

**åƒæ•¸ï¼š**
- `parameter: str` - åƒæ•¸åç¨±
- `value: Any` - ç„¡æ•ˆå€¼
- `valid_range: str` - æœ‰æ•ˆç¯„åœæˆ–å€¼çš„èªªæ˜
- `suggestions: Optional[SuggestionList]` - ä¿®å¾©å»ºè­°ï¼ˆé è¨­: Noneï¼‰

**å›å‚³ï¼š** `str` - æ ¼å¼åŒ–çš„éŒ¯èª¤è¨Šæ¯

#### `format_processing_error()`

æ ¼å¼åŒ–æ‰¹æ¬¡è™•ç†éŒ¯èª¤ã€‚

**åƒæ•¸ï¼š**
- `item: str` - æ­£åœ¨è™•ç†çš„é …ç›®
- `error: Exception` - ç™¼ç”Ÿçš„ç•°å¸¸
- `batch_info: Optional[ErrorContext]` - æ‰¹æ¬¡ä¸Šä¸‹æ–‡è³‡è¨Šï¼ˆé è¨­: Noneï¼‰

**å›å‚³ï¼š** `str` - æ ¼å¼åŒ–çš„éŒ¯èª¤è¨Šæ¯

### è¼”åŠ©å‡½æ•¸

#### `log_structured_error()`

ä½¿ç”¨çµæ§‹åŒ–æ ¼å¼è¨˜éŒ„éŒ¯èª¤ã€‚

**åƒæ•¸ï¼š**
- `logger_obj: logging.Logger` - Logger å¯¦ä¾‹
- `error: Exception` - è¦è¨˜éŒ„çš„ç•°å¸¸
- `component: str` - ç™¼ç”ŸéŒ¯èª¤çš„å…ƒä»¶
- `context: Optional[ErrorContext]` - ä¸Šä¸‹æ–‡è³‡è¨Šï¼ˆé è¨­: Noneï¼‰
- `level: int` - æ—¥èªŒå±¤ç´šï¼ˆé è¨­: logging.ERRORï¼‰

**å›å‚³ï¼š** `None`

### å‹åˆ¥åˆ¥å

```python
ErrorContext = Dict[str, Any]      # ä¸Šä¸‹æ–‡å­—å…¸
SuggestionList = List[str]         # å»ºè­°åˆ—è¡¨
```

### å¸¸æ•¸

```python
MAX_CONTEXT_VALUE_LENGTH = 500     # å–®ä¸€å€¼æœ€å¤§é•·åº¦
MAX_TOTAL_CONTEXT_LENGTH = 2000    # ç¸½é•·åº¦é™åˆ¶
```

---

## ç›¸é—œè³‡æº

ğŸ“š **ç›¸é—œæ–‡æª”ï¼š**
- [ä½¿ç”¨æ‰‹å†Š](./ä½¿ç”¨æ‰‹å†Š.md) - å®Œæ•´åŠŸèƒ½èªªæ˜
- [SDK ä»£ç†æ¨¡å¼](./SDKä»£ç†æ¨¡å¼æŒ‡å—.md) - é›™å‘å°è©±æ¨¡å¼
- [æœ€ä½³å¯¦è¸](./æœ€ä½³å¯¦è¸.md) - é€²éšæŠ€å·§

ğŸ†˜ **éœ€è¦å¹«åŠ©ï¼š**
- [å¸¸è¦‹å•é¡Œ](./å¸¸è¦‹å•é¡Œ.md)
- [æ•…éšœæ’é™¤](./æ•…éšœæ’é™¤.md)
- [GitHub Issues](https://github.com/yourusername/springmvc-agent-analyzer/issues)

---

**ä¸Šä¸€ç¯‡ï¼š** [â† SDK ä»£ç†æ¨¡å¼æŒ‡å—](./SDKä»£ç†æ¨¡å¼æŒ‡å—.md)
**ä¸‹ä¸€ç¯‡ï¼š** [æœ€ä½³å¯¦è¸ â†’](./æœ€ä½³å¯¦è¸.md)
